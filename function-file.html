<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Function File</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script type="text/javascript">
        // The Office initialize function must be run each time a new page is loaded
        Office.initialize = function () {
            console.log("Office.initialize in function-file");
        };
        
        // AuthenticationHandler Class (identical to taskpane.js)
        class AuthenticationHandler {
            constructor() {
                this.msalInstance = null;
                this.isInitialized = false;
                this.scopes = ["Mail.ReadWrite", "Mail.Send"];
                this.tenantId = "common";
            }
            
            async initialize() {
                // Make sure MSAL is available
                if (typeof msal === 'undefined') {
                    console.error("MSAL library not loaded");
                    return false;
                }

                try {
                    const msalConfig = {
                        auth: {
                            clientId: "f2ec0036-695b-419b-bbc7-fa83e14a7ccc",
                            authority: `https://login.microsoftonline.com/${this.tenantId}`,
                            redirectUri: "https://smallcharbel.github.io/function-file.html"
                        },
                        cache: {
                            cacheLocation: "sessionStorage",
                            storeAuthStateInCookie: true
                        }
                    };

                    // Initialize MSAL instance
                    this.msalInstance = new msal.PublicClientApplication(msalConfig);
                    this.isInitialized = true;
                    
                    // Handle the redirect flow
                    await this.msalInstance.handleRedirectPromise().catch(error => {
                        console.error("Error handling redirect:", error);
                    });
                    
                    console.log("Authentication initialized successfully");
                    return true;
                } catch (error) {
                    console.error("Failed to initialize authentication:", error);
                    return false;
                }
            }
            
            async getAccessToken() {
                if (!this.isInitialized || !this.msalInstance) {
                    const initialized = await this.initialize();
                    if (!initialized) {
                        throw new Error("Authentication could not be initialized");
                    }
                }
                
                try {
                    // Check if user is signed in
                    const accounts = this.msalInstance.getAllAccounts();
                    
                    if (accounts.length === 0) {
                        // No user signed in, initiate login
                        const loginRequest = {
                            scopes: this.scopes
                        };
                        
                        // Try popup login first
                        try {
                            console.log("No accounts found, attempting login popup");
                            const loginResponse = await this.msalInstance.loginPopup(loginRequest);
                            console.log("Login successful:", loginResponse);
                        } catch (err) {
                            console.error("Popup login failed:", err);
                            console.log("Falling back to redirect login");
                            await this.msalInstance.loginRedirect(loginRequest);
                            return null; // This will redirect
                        }
                    }
                    
                    // Get the account again (in case we just logged in)
                    const currentAccounts = this.msalInstance.getAllAccounts();
                    
                    if (currentAccounts.length === 0) {
                        throw new Error("No accounts found after login attempt");
                    }
                    
                    // Get token silently
                    const tokenRequest = {
                        scopes: this.scopes,
                        account: currentAccounts[0]
                    };
                    
                    console.log("Requesting token for account:", currentAccounts[0].username);
                    const tokenResponse = await this.msalInstance.acquireTokenSilent(tokenRequest);
                    console.log("Token acquired successfully");
                    
                    return tokenResponse.accessToken;
                } catch (error) {
                    // If silent token acquisition fails, try interactive
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        console.log("Silent token acquisition failed, trying popup:", error);
                        
                        try {
                            const tokenRequest = {
                                scopes: this.scopes
                            };
                            
                            const tokenResponse = await this.msalInstance.acquireTokenPopup(tokenRequest);
                            console.log("Interactive token acquisition successful");
                            return tokenResponse.accessToken;
                        } catch (err) {
                            console.error("Interactive token acquisition failed:", err);
                            throw err;
                        }
                    } else {
                        console.error("Failed to get access token:", error);
                        throw error;
                    }
                }
            }
        }
        
        // Create a single instance of the auth handler
        const authHandler = new AuthenticationHandler();
        
        // Function that runs when the button is clicked - EXACT SAME LOGIC as taskpane.js
        async function forwardEmailWithAttachments(event) {
            // Show progress notification
            Office.context.mailbox.item.notificationMessages.addAsync("forward-status", {
                type: "progressIndicator",
                message: "Processing email..."
            });
            
            try {
                // Get the access token - this will initialize auth if needed
                console.log("Getting access token");
                const accessToken = await authHandler.getAccessToken();
                
                if (!accessToken) {
                    console.error("Failed to obtain access token");
                    Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                        type: "errorMessage",
                        message: "Failed to obtain authentication token. Please try again."
                    });
                    event.completed();
                    return;
                }
                
                console.log("Token obtained successfully", accessToken.substring(0, 10) + "...");
                
                // Get the current item
                const item = Office.context.mailbox.item;
                const messageId = item.itemId;
                
                if (!messageId) {
                    console.error("Could not retrieve email ID");
                    Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                        type: "errorMessage",
                        message: "Could not retrieve email ID"
                    });
                    event.completed();
                    return;
                }
                
                // Update notification
                Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                    type: "progressIndicator",
                    message: "Connecting to service..."
                });
                
                // Call your Azure Function
                const functionUrl = "https://outlookaddintestptai.azurewebsites.net/api/forward-email?code=qZtLOtMh1tNugQdgNA20-2KnY0-2vIc9hkpamqw1c99bAzFudm7pyQ==";
                
                console.log("Sending request to function with authorization header");
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        messageId: messageId,
                        accessToken: accessToken // Also send in body as fallback
                    })
                });
                
                const responseText = await response.text();
                console.log("Response from function:", responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse response as JSON:", responseText);
                    Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                        type: "errorMessage",
                        message: "Invalid response from server"
                    });
                    event.completed();
                    return;
                }
                
                if (!response.ok) {
                    console.error(`Function returned status ${response.status}:`, result);
                    Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                        type: "errorMessage",
                        message: `Error: ${result.error || `Function returned status ${response.status}`}`
                    });
                    event.completed();
                    return;
                }
                
                if (result.success) {
                    Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                        type: "informationalMessage",
                        message: "Email forwarded successfully with all attachments!",
                        icon: "Icon.16x16",
                        persistent: false
                    });
                } else {
                    Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                        type: "errorMessage",
                        message: `Error: ${result.error || "Unknown error"}`
                    });
                }
                
                // Complete the function
                event.completed();
            } catch (error) {
                console.error("Error forwarding email:", error);
                Office.context.mailbox.item.notificationMessages.replaceAsync("forward-status", {
                    type: "errorMessage",
                    message: `Error: ${error.message}`
                });
                event.completed();
            }
        }
        
        // Make the function available to the Office runtime
        Office.actions.associate("forwardEmailWithAttachments", forwardEmailWithAttachments);
    </script>
</head>
<body>
    <!-- NOTE: This file should provide no UI but only contains code -->
</body>
</html> 