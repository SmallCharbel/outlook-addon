<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Function File</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <script type="text/javascript">
        // Global variables
        let msalInstance = null;
        const scopes = ["Mail.ReadWrite", "Mail.Send"];
        
        // Initialize Office
        Office.initialize = function (reason) {
            // Register the function handler
            Office.actions.associate("forwardEmailDirectly", handleForwardEmail);
        };
        
        // Main function to handle forwarding
        async function handleForwardEmail(event) {
            try {
                // Step 1: Initialize MSAL if not already done
                if (!msalInstance) {
                    msalInstance = new msal.PublicClientApplication({
                        auth: {
                            clientId: "f2ec0036-695b-419b-bbc7-fa83e14a7ccc",
                            authority: "https://login.microsoftonline.com/common",
                            redirectUri: "https://smallcharbel.github.io/function-file.html"
                        },
                        cache: {
                            cacheLocation: "sessionStorage",
                            storeAuthStateInCookie: true
                        }
                    });
                }
                
                // Step 2: Show processing message
                showNotification("Processing email...", "progress");
                
                // Step 3: Get access token
                let accessToken;
                try {
                    // Check for existing accounts
                    const accounts = msalInstance.getAllAccounts();
                    
                    if (accounts.length === 0) {
                        // No signed-in user, try popup login
                        try {
                            const loginResponse = await msalInstance.loginPopup({
                                scopes: scopes
                            });
                            console.log("Login successful");
                        } catch (loginError) {
                            console.error("Login failed:", loginError);
                            showNotification("Authentication failed. Please try again.", "error");
                            event.completed();
                            return;
                        }
                    }
                    
                    // Get token silently if possible
                    try {
                        const currentAccounts = msalInstance.getAllAccounts();
                        const tokenResponse = await msalInstance.acquireTokenSilent({
                            scopes: scopes,
                            account: currentAccounts[0]
                        });
                        accessToken = tokenResponse.accessToken;
                    } catch (silentError) {
                        // If silent acquisition fails, try popup
                        console.log("Silent token acquisition failed, trying popup");
                        const tokenResponse = await msalInstance.acquireTokenPopup({
                            scopes: scopes
                        });
                        accessToken = tokenResponse.accessToken;
                    }
                } catch (tokenError) {
                    console.error("Token acquisition failed:", tokenError);
                    showNotification("Failed to get authentication token", "error");
                    event.completed();
                    return;
                }
                
                if (!accessToken) {
                    showNotification("Failed to obtain authorization", "error");
                    event.completed();
                    return;
                }
                
                // Step 4: Get the message ID
                const item = Office.context.mailbox.item;
                const messageId = item.itemId;
                
                if (!messageId) {
                    showNotification("Could not retrieve email ID", "error");
                    event.completed();
                    return;
                }
                
                // Step 5: Call the Azure Function
                showNotification("Forwarding email...", "progress");
                
                const functionUrl = "https://outlookaddintestptai.azurewebsites.net/api/forward-email?code=qZtLOtMh1tNugQdgNA20-2KnY0-2vIc9hkpamqw1c99bAzFudm7pyQ==";
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        messageId: messageId,
                        accessToken: accessToken
                    })
                });
                
                // Step 6: Process the response
                const responseText = await response.text();
                let result;
                
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error("Invalid response:", responseText);
                    showNotification("Received invalid response from server", "error");
                    event.completed();
                    return;
                }
                
                if (response.ok && result.success) {
                    showNotification("Email forwarded successfully with all attachments!", "success");
                } else {
                    const errorMessage = result.error || `Error: ${response.status}`;
                    showNotification(errorMessage, "error");
                }
                
            } catch (error) {
                console.error("Error in forward operation:", error);
                showNotification(`Error: ${error.message}`, "error");
            }
            
            // Always complete the event
            event.completed();
        }
        
        // Helper function to show notifications
        function showNotification(message, type) {
            const notificationId = "forward-notification";
            let notificationOptions;
            
            switch (type) {
                case "progress":
                    notificationOptions = {
                        type: "progressIndicator",
                        message: message
                    };
                    break;
                    
                case "error":
                    notificationOptions = {
                        type: "errorMessage",
                        message: message
                    };
                    break;
                    
                case "success":
                default:
                    notificationOptions = {
                        type: "informationalMessage",
                        message: message,
                        icon: "Icon.16x16",
                        persistent: false
                    };
                    break;
            }
            
            Office.context.mailbox.item.notificationMessages.replaceAsync(
                notificationId,
                notificationOptions
            );
        }
    </script>
</head>
<body>
    <!-- This is a function file with no UI -->
</body>
</html> 